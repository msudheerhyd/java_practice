<html>
    <head>
        <title>Radu's Avatar</title>
        <style>
            canvas{
                border: 1px solid black;
            }
            body{
                margin:0;
            }
            #sliders{
                position:absolute;
                top:0;
                left:310; 
            }
            #camCanvas{
                    max-width: 173px    ;
            }
        </style>
    </head>
    <body>
        <canvas id="myCanvas"></canvas>
        <div id="sliders">
            x: <input type="range" min="-0.5" max="0.5" step="0.1" onChange="updateLookAt(this,'x')"/>
            <br>
            y: <input type="range" min="-0.5" max="0.5" step="0.1" onChange="updateLookAt(this,'y')"/>
            <br>
            <canvas id="camCanvas"></canvas>
        </div>
        <script src="camera.js"></script>
        <script src="utils.js"></script>
        <script src="avatar.js"></script>
        <script src="eye.js"></script>
        <script src="beard.js"></script>
        <script src="hair.js"></script>
        <script>
            const DEBUG=false;
            const canvas=document.getElementById("myCanvas");
            canvas.width=300;
            canvas.height=300;

            const ctx=canvas.getContext("2d");
            const camCtx=camCanvas.getContext("2d");

            // prepare canvas so coordinates are in [-1,1]
            ctx.lineWidth=0.01;
            ctx.translate(canvas.width/2,canvas.height/2);
            ctx.scale(canvas.width*0.5,canvas.height*0.5);
            const img=new Image();
            img.src="portrait1.png";

            const skinTone="rgb(254,184,150)";
            const shirtColor="rgb(154,153,1)";


            // point A
            const lookAt={x:0,y:-0.13,xRange:[0,0.2],yRange:[-0.13,0.1],xOffset:0,yOffset:0};
            const avatar=new Avatar(lookAt);

            img.onload=function(){
                animate();
            }

            // TO-DO: Remove this when done designing the character
            canvas.addEventListener("click", getCoords);
            function getCoords(evt){
                const x=(evt.x-canvas.width/2)/(canvas.width/2);
                const y=(evt.y-canvas.height/2)/(canvas.height/2);
                const offset={
                    x:x-lookAt.x,
                    y:y-lookAt.y
                }
                console.log(offset.x.toFixed(2)+","+offset.y.toFixed(2)); 
            }
            // END TO-DO

            function animate(){
                // TO-DO: Remove this when done designing the character
                ctx.clearRect(-1,-1,2,2);
                /*
                ctx.globalAlpha=0.2;
                ctx.drawImage(img,-1,-1,2,2);  
                ctx.globalAlpha=1;
                */                  
                // END TO-DO

                if(video){
                    camCtx.drawImage(video,0,0);
                    const imgData=camCtx.getImageData(0,0,camCanvas.width,camCanvas.height);
                    const locs=getMarkedLocations(imgData);
                    if(locs.length>0){
                        const avg=average(locs); 
                       // console.log(avg);
                        const x=(avg.x-imgData.width/2)/imgData.width;
                        const y=(avg.y-imgData.height/2)/imgData.height;
                        console.log({x,y});

                        updateLookAt({value:x},'x');
                        updateLookAt({value:y},'y');

                    }
                }

                avatar.draw(ctx);
                requestAnimationFrame(animate);
            }      

            // called when playing with sliders
            function updateLookAt(info,attr){
                const p=lookAt;
                let yRange=p.yRange;
                let value=info.value;
                if(p.yNegRange){
                    yRange=info.value<0?p.yNegRange:p.yRange;
                    value=Math.abs(value);
                }
                switch(attr){
                    case "x":
                        p.xOffset=value;
                        p.x=lerp(p.xRange[0],p.xRange[1],info.value);
                        break;
                    case "y":
                    p.yOffset=value;
                        p.y=lerp(yRange[0],yRange[1],value);  
                        break; 
                }     
            }
        </script>
    </body>
</html>
